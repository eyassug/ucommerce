@using UCommerce.Catalog
@using UCommerce.EntitiesV2
@using UCommerce.Transactions
@{
    if (HttpContext.Current.Request.HttpMethod == "POST" && HttpContext.Current.Request.Form.AllKeys.Any(x => x == "updatePayment"))
    {
        int newPaymentMethodId;
        if (int.TryParse(HttpContext.Current.Request.Form["PaymentMethod"], out newPaymentMethodId))
        {
            TransactionLibrary.CreatePayment(newPaymentMethodId);
            TransactionLibrary.ExecuteBasketPipeline();
            HttpContext.Current.Response.Redirect("Preview.aspx");
        }
        
    }
    
    var basket = TransactionLibrary.GetBasket().PurchaseOrder;
    var payment = basket.Payments.FirstOrDefault();
}
@helper RenderPaymentMethodLabel(PaymentMethod paymentMethod, PurchaseOrder basket)
{
    decimal feePercent = paymentMethod.FeePercent;

    var fee = paymentMethod.GetFeeForCurrency(basket.BillingCurrency);
    var formattedPrice = CatalogLibrary.FormatCurrency(fee == null ? 0 : fee.Fee);
    
    @paymentMethod.Name <text>(</text>@formattedPrice <text>+</text> @feePercent<text>%)</text> 
    
}
<form  method="post">
    <div class="row-fluid well" >
        <div class="span6">
            <h3>Payment method</h3>
            <br/>
            @foreach (var paymentMethod in TransactionLibrary.GetPaymentMethods("Shipment"))
            {
                <label class="radio">
                    <input type="radio" name="PaymentMethod"  @(payment != null && payment.PaymentMethod.Equals(paymentMethod) ? "checked" : string.Empty) 
                        value="@paymentMethod.PaymentMethodId" />@RenderPaymentMethodLabel(paymentMethod, basket)</label>
            }

        </div>
    </div>
    <input name="updatePayment" class="btn btn-primary" type="submit" value="Next"/>
</form>