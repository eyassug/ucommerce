@using UCommerce.Api
@{
    var request = HttpContext.Current.Request;
    if (request.HttpMethod == "POST" && request.Form.AllKeys.Any(x => x == "send-order"))
    {
        TransactionLibrary.ExecuteBasketPipeline();
        TransactionLibrary.Checkout();
        HttpContext.Current.Response.Redirect("Confirmation.aspx");

    }
    var basket = TransactionLibrary.GetBasket().PurchaseOrder;
    var billingAddress = TransactionLibrary.GetBillingInformation();
    var shipmentAddress = TransactionLibrary.GetShipmentInformation();
    var shipments = basket.Shipments;
}
<form method="post">
<div class="row-fluid well">
    <div class="span6">
        <h3>Billing address</h3>
        <br />
        <address><strong>@billingAddress.FirstName @billingAddress.LastName</strong><br>
            @billingAddress.Line1<br>
            @billingAddress.PostalCode @billingAddress.City<br>
            @billingAddress.Country.Name
            @if (!String.IsNullOrWhiteSpace(@billingAddress.Attention))
            {
                <text>att. </text> @billingAddress.Attention
            }<br>
            <abbr title="Phone">P:</abbr>@billingAddress.PhoneNumber<br>
            <abbr title="Mobile">M:</abbr>@billingAddress.MobilePhoneNumber<br>
            <abbr title="Email">E:</abbr><a href="mailto:@billingAddress.EmailAddress">@billingAddress.EmailAddress</a> </address>
    </div>
    <div class="span6">
        <h3>Shipping address</h3>
        <br />
        <address><strong>@shipmentAddress.FirstName @shipmentAddress.LastName</strong><br>
            @shipmentAddress.CompanyName
            @if (!String.IsNullOrWhiteSpace(@shipmentAddress.Attention))
            {
                <text>att. </text> @shipmentAddress.Attention
            }<br />
            @shipmentAddress.Line1<br>
            @shipmentAddress.PostalCode @shipmentAddress.City<br>
            @shipmentAddress.Country.Name<br>
            <abbr title="Phone">P:</abbr>@shipmentAddress.PhoneNumber<br>
            <abbr title="Mobile">M:</abbr>@shipmentAddress.MobilePhoneNumber<br>
            <abbr title="Email">E:</abbr><a href="mailto:@shipmentAddress.EmailAddress">@shipmentAddress.EmailAddress</a> </address>
    </div>
</div>
<div class="row-fluid">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Item no. </th>
                <th class="span7">Description</th>
                <th class="span1 money">Price</th>
                <th class="span1 money">VAT</th>
                <th class="span2">Quantity</th>
                <th class="span1 money">Total</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var lineItem in basket.OrderLines)
            {
                <tr>
                    <td>@lineItem.Sku</td>
                    <td>@lineItem.ProductName</td>
                    <td class="money">
                        @if (lineItem.UnitDiscount.HasValue && lineItem.UnitDiscount > 0)
                        {
                            <span style="text-decoration: line-through">
                                @TransactionLibrary.FormatCurrency(lineItem.Price)
                            </span>
                            @TransactionLibrary.FormatCurrency(lineItem.Price - lineItem.UnitDiscount)    
                        }
                        else
                        {
                            @TransactionLibrary.FormatCurrency(lineItem.Price)    
                        }
                    </td>
                    <td class="money">@TransactionLibrary.FormatCurrency(lineItem.VAT)</td>
                    <td>@lineItem.Quantity</td>
                    <td class="money">@TransactionLibrary.FormatCurrency(lineItem.Total)</td>
                </tr>
            }
            <tr>
                <td rowspan="6" colspan="2"></td>
                <td colspan="3">Sub total: </td>
                <td class="money">
                    @TransactionLibrary.FormatCurrency(basket.SubTotal)
                </td>
            </tr>
            <tr>
                <td colspan="3">VAT: </td>
                <td class="money">
                    @TransactionLibrary.FormatCurrency(basket.VAT)
                </td>
            </tr>
            <tr>
                <td colspan="3">Order discounts: </td>
                <td class="money">-@TransactionLibrary.FormatCurrency(basket.Discount)</td>
            </tr>
            <tr>
                <td colspan="3">Shipping
                    @if (shipments.Count > 1)
                    {
                        <ul>
                            @foreach (var shipment in shipments)
                            {
                                <li>@shipment.ShipmentName</li>
                            }
                        </ul>
                    }
                    else
                    {
                        <text> (via </text>@shipments.First().ShipmentName<text>)</text>
                    }
                </td>
                <td class="money">@TransactionLibrary.FormatCurrency(basket.ShippingTotal)</td>
            </tr>
            <tr>
                <td colspan="3">Payment
                    @if (basket.Payments.Count > 1)
                    {
                        <ul>
                            @foreach (var payment in basket.Payments)
                            {
                                <li>@payment.PaymentMethodName</li>
                            }
                        </ul>
                    }
                    else
                    {
                        <text> (</text>@basket.Payments.First().PaymentMethodName<text>)</text>                        
                    }
                </td>
                <td class="money">@TransactionLibrary.FormatCurrency(basket.PaymentTotal)</td>
            </tr>
            <tr>
                <td colspan="3">Order total: </td>
                <td class="money">@TransactionLibrary.FormatCurrency(basket.OrderTotal)</td>
            </tr>
        </tbody>
    </table>
</div>
<a href="/shop/checkout/payment.aspx" class="btn btn-small">Back to Payment Method</a>
<button name="send-order" class="pull-right btn btn-large btn-success" type="submit">Complete Order <i class="icon-arrow-right icon-white"></i>
</form>
