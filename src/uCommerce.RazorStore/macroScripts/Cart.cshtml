@using UCommerce
@using UCommerce.Api
@using UCommerce.Runtime
@{
    var basket = TransactionLibrary.GetBasket(true).PurchaseOrder;
    var request = HttpContext.Current.Request;
    var currency = SiteContext.Current.CatalogContext.CurrentCatalog.PriceGroup.Currency;
    
    if (request.HttpMethod == "POST")
    {
        if (request.Form.AllKeys.Any(x => x.StartsWith("add-voucher")))
        {
            var code = request.Form["voucher-code"];
            if (!string.IsNullOrWhiteSpace(code))
            {
                MarketingLibrary.AddVoucher(code);
                TransactionLibrary.ExecuteBasketPipeline();
            }
        }

        if (request.Form.AllKeys.Any(x => x.StartsWith("update-basket-line")))
        {
            int orderLineId;
            int newQuantity;

            if (int.TryParse(request.Form["update-basket-line"], out orderLineId) && int.TryParse(request.Form["quantity-input_" + orderLineId], out newQuantity))
            {
                TransactionLibrary.UpdateLineItem(orderLineId, newQuantity);
            }
            TransactionLibrary.ExecuteBasketPipeline();
        }

        if (request.Form.AllKeys.Any(x => x.StartsWith("update-basket")))
        {
            foreach (var orderLineId in basket.OrderLines.Select(x => x.OrderLineId).ToList())
            {
                int newQuantity;
                if (int.TryParse(request.Form["quantity-input_" + orderLineId], out newQuantity))
                {
                    TransactionLibrary.UpdateLineItem(orderLineId, newQuantity);
                }
            }
            TransactionLibrary.ExecuteBasketPipeline();
        }

        if (request.Form.AllKeys.Any(x => x == "update-and-continue"))
        {
            HttpContext.Current.Response.Redirect("Address.aspx");
        }

        HttpContext.Current.Response.Redirect(request.RawUrl);
    }

    var subTotal = new Money(basket.SubTotal.Value, currency);
    var vat = new Money(basket.VAT.Value, currency);
    var discount = new Money(basket.Discount.Value, currency);
    var orderTotal = new Money(basket.OrderTotal.Value, currency);
}
<form method="post">
<div class="row-fluid">
    <table class="table table-striped" id="cart">
        <thead>
            <tr>
                <th class="span7">Description</th>
                <th class="span1 money">Price</th>
                <th class="span1 money">VAT</th>
                <th class="span2">Quantity</th>
                <th class="span1 money">Total</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var lineItem in basket.OrderLines)
            {
                var product = @CatalogLibrary.GetProduct(lineItem.Sku);
                var itemPrice = new Money(lineItem.Price, currency);
                var itemVAT = new Money(lineItem.VAT, currency);
                var lineTotal = new Money(lineItem.Total.Value, currency);

                <tr class="order-line">
                    <td><a href="@CatalogLibrary.GetNiceUrlForProduct(product)">@lineItem.ProductName</a> </td>
                    <td class="money">
                        @if (lineItem.UnitDiscount.HasValue && lineItem.UnitDiscount > 0)
                        {
                            var nowPrice = new Money((lineItem.Price - lineItem.UnitDiscount.Value), currency);
                            
                            <span style="text-decoration: line-through">
                                @itemPrice
                            </span>
                            @nowPrice    
                        }
                        else
                        {
                            @itemPrice
                        }
                    </td>
                    <td class="money">
                        @itemVAT
                    </td>
                    <td>
                        <div class="input-append">
                            <input type="text" name="quantity-input_@(lineItem.OrderLineId)" value="@lineItem.Quantity" class="qty" />
                            <button name="update-basket-line" class="btn btn-success update-cart" type="submit" value="@lineItem.OrderLineId"><i class="icon-refresh icon-white"></i></button>
                        </div>
                    </td>
                    <td class="money line-total">
                        @lineTotal
                    </td>
                    <td>
                        <button type="button" class="line-remove">×</button></td>
                </tr>
            }
            <tr>
                <td rowspan="4">
                    <div class="span6">
                        <div class="input-append">
                            <input type="text" name="voucher-code" />
                            <button name="add-voucher" class="btn" type="submit"><i class="icon-plus"></i>Add Voucher</button>
                        </div>
                        <p><span class="label label-info">Tip!</span> <small>Sign up to our mailing list and get 10% off your first order! <a href="#">Click here to get 10% off now</a>!</small></p>
                    </div>
                </td>
                <td colspan="2" rowspan="4">
                    <button name="update-basket" class="btn update-basket" type="submit"><i class="icon-refresh"></i>Update</button>
                </td>
                <td>Sub total:</td>
                <td class="money order-subtotal">
                    @subTotal
                </td>
                <td>&nbsp;</td>
            </tr>
            <tr>
                <td>VAT:</td>
                <td class="money order-tax">
                    @vat
                </td>
                <td>&nbsp;</td>
            </tr>
            <tr>
                <td>Discounts:</td>
                <td class="money order-discount">
                    @discount
                </td>
                <td>&nbsp;</td>
            </tr>
            <tr>
                <td>Order total:</td>
                <td class="money order-total">
                    @orderTotal
                </td>
                <td>&nbsp;</td>
            </tr>
        </tbody>
    </table>
    <div class="pull-right">
        <button name="update-and-continue" class="btn btn-large btn-success" type="submit">Continue to Checkout <i class="icon-arrow-right icon-white"></i></button>
    </div>
</div>
</form>
