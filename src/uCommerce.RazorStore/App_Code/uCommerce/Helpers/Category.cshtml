@using System.Text
@using UCommerce.Api
@using UCommerce.Extensions
@using UCommerce.EntitiesV2
@using UCommerce.Infrastructure
@using UCommerce.Runtime
@using umbraco.MacroEngines
@helper DisplayCategoryProducts(UCommerce.EntitiesV2.Category category)
    {
        var ordersRepository = ObjectFactory.Instance.Resolve<IRepository<OrderLine>>();
        var products = CatalogLibrary.GetProducts(category).AsQueryable();



    var ordersStatistics = 
        from orderLine in ordersRepository.Select()
        join product in products
            on new {orderLine.Sku, orderLine.VariantSku} equals new {product.Sku, product.VariantSku}
        
        select new
        {
            Sku = orderLine.Sku,
            VariantSku = orderLine.VariantSku
            
        };
        
        @uCommerce.Helpers.Product.DisplayListProducts(products, category)
        foreach (var childCategory in category.Categories)
        {
            @DisplayCategoryProducts(childCategory)
        }
}
